{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
<style>
    body{
	background-color: #efefef !important;
}
.single-blog{
	box-shadow: 0px 0px 20px 1px rgba(0,0,0,0.2);
	padding: 10px;
	margin-top: 30px;
    background-color: #fff;
    text-align: center;
}

.single-blog img{
    width: 250px;
    height: 250px;
    object-fit: cover;
}

.blog-meta{
	font-size: 14px;
	margin-bottom: 2px;
}
.single-blog span{
	float: right;
	font-size: 12px;
	color: cornflowerblue;
}
.blog-text{
	font-size: 14px;
    text-align: center;
    overflow-x: auto;
    white-space: pre-wrap;
    white-space: -moz-pre-wrap !important;
    word-wrap: break-word;
    white-space : normal;
}
.single-blog h2{
	margin-top: 10px;
	font-size: 16px;
	color: #007bff;
}
.single-blog h2 a{
	text-decoration: none;
}

</style>
{% endblock %}
{% block extra_nav %}
<ul class="navbar-nav">
    <li class="nav-item">
        <a class="nav-link" href="#CreateTestModal" data-toggle="modal" data-target="#CreateTestModal">
        <i class="fa fa-plus">
        </i>
        Create Test
        </a>
    </li>
</ul>
{% endblock %}
{% block content %}
<!--  -->
<div class="modal" id="CreateTestModal" tabindex="-1" role="dialog" aria-labelledby="CreateModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="test-create-form">{% csrf_token %}
                <div class="modal-body">
                    <p class="modal-title m-2">Category</p>
                    {{create_form.category}}
                    </button>
                </div>
                <div class="modal-body">
                    <p class="modal-title m-2">Title of the new test</p>
                    {{create_form.title}}
                    </button>
                </div>
                <div class="modal-body">
                    <p>Description</p>
                    {{create_form.description}}
                </div>
                <div class="modal-body">
                    <p>Image</p>
                    {{create_form.image}}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Test</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!--  -->
<div class="tests m-5 row" id="tests_list">
{% for test in tests %}
<!--  -->
    <div class="modal" id="UpdateTestModal{{test.id}}" tabindex="-1" role="dialog" aria-labelledby="UpdateModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form class="update-form" action="{% url 'my-test-update' test.id %}" method="POST" id="testUpdateForm{{test.id}}">{% csrf_token %}
                    <div class="modal-body">
                        <p class="modal-title m-2">Title of the new test</p>
                        {{update_form.title}}
                        </button>
                    </div>
                    <div class="modal-body">
                        <p class="modal-title m-2">Description</p>
                        {{update_form.description}}
                    </div>
                    <div class="modal-body">
                        <p class="modal-title m-2">Is Active</p>
                        {{update_form.is_active}}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" form="testUpdateForm{{test.id}}">Update Test</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<!--  -->
    <div class="col-md-4" id="test{{test.id}}">
        <div class="single-blog">
            <p class="blog-meta">
                By {{test.user}}
                <span>{{test.created}}</span>
            </p>
            <img src="{{test.image.url}}" alt="{{test.title}}">
            <h2><a href="{% url 'question-list' test.id %}">{{test.title}}</a></h2>
            <p class="blog-text">{{test.description|truncatechars:30}}</p>
            <p>
                <button data-url="{% url 'my-test-update' test.id %}" data-id="{{test.id}}" class="btn btn-success update-button">Update</button>
                <div data-id="{{test.id}}" data-url="{% url 'my-test-delete' test.id %}" class="btn btn-danger delete-button">Delete</div>
            </p>
        </div>
    </div>
{% endfor %}
</div>
{% endblock content %}

{% block javascript %}
    {{ block.super }}
    <script type="text/javascript">
        $(document.body).on('click', '.update-button', function (e){
            modal_id = $(this).data('id');
            update_url = $(this).data('url');
            modal_window = $(`#UpdateTestModal${modal_id}`);
            modal_form = $(`#testUpdateForm${modal_id}`);
            $.ajax({
                type: "GET",
                url: update_url,
                data: {test_id: parseInt(modal_id)},
                success: function (response) {
                    modal_form[0][1].value = response['test_title'];
                    modal_form[0][2].value = response['test_description'];
                    modal_form[0][3].checked = response['test_is_active'];
                }
            })
            modal_window.modal('show');
        });

        $("#test-create-form").submit(function (e) {
            e.preventDefault();
            var form_data = new FormData(this);
            var serialized_data = $(this).serialize();
            $.ajax({
                type: "POST",
                url: "{% url 'my-test-create' %}",
                data: form_data,
                success: function (response) {
                    $("#test-create-form").trigger('reset');
                    $("#id_title").focus();

                    var instance = JSON.parse(response["new_test"]);
                    var fields = instance[0]["fields"];
                    console.log(instance);
                    var test_detail_url = response['detail_url'];
                    var test_update_url = response['update_url'];
                    var test_delete_url = response['delete_url'];
                    
                    $("#tests_list").prepend(`
                        <div class="modal" id="UpdateTestModal${instance[0].pk}" tabindex="-1" role="dialog" aria-labelledby="UpdateModalLabel">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <form class="update-form" action="${test_update_url}" method="POST" id="testUpdateForm${instance[0].pk}">{% csrf_token %}
                                        <div class="modal-body">
                                            <p class="modal-title m-2">Title of the new test</p>
                                            {{update_form.title}}
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <p class="modal-title m-2">Description</p>
                                            {{update_form.description}}
                                        </div>
                                        <div class="modal-body">
                                            <p class="modal-title m-2">Is Active</p>
                                            {{update_form.is_active}}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            <button type="submit" class="btn btn-primary" form="testUpdateForm${instance[0].pk}">Update Test</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" id="test${instance[0].pk}">
                            <div class="single-blog">
                                <p class="blog-meta">
                                    By ${fields['user']}
                                    <span>${fields['created']}</span>
                                </p>
                                <img src="${fields['image']}" alt="${fields['title']}">
                                <h2><a href="${test_detail_url}">${fields['title']}</a></h2>
                                <p class="blog-text">${fields['description'].slice(0, 30)}</p>
                                <p>
                                    <button data-url="${test_update_url}" data-id="${instance[0].pk}" class="btn btn-success update-button">Update</button>
                                    <div data-id="${instance[0].pk}" data-url="${test_delete_url}" class="btn btn-danger delete-button">Delete</div>
                                </p>
                            </div>
                        </div>
                    `);
                    
                    $("#CreateTestModal").modal('hide');

                },
                error: function (response) {
                    alert(response["responseJSON"]["error"]);
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });

        var csrfToken = $("input[name=csrfmiddlewaretoken]").val();

        $(document.body).on('click', '.delete-button', function(e){
            e.stopPropagation();
            var delete_url = $(this).data('url');
            var data_id = $(this).data('id');
            $.ajax({
                type: "POST",
                url: `${delete_url}`,
                data: {
                    csrfmiddlewaretoken: csrfToken,
                    test_id: data_id
                },
                dataType: 'json',
                success: function() {
                    $(`#test${data_id}`).remove();
                }
            })
        });
    </script>
{% endblock %}