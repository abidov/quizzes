{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/my_quiz_detail.css' %}">
    <title>Document</title>
</head>
<body>
    <!--  -->
    <div class="modal" id="CreateQuestionModal" tabindex="-1" role="dialog" aria-labelledby="CreateModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="question-form" action="{% url 'question-create' test.id %}">{% csrf_token %}
                    <div class="modal-body">
                        <p class="modal-title m-2">Question</p>
                        {{question_form.problem}}
                        </button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Create Question</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--  -->
    <button type="button" class="btn btn-primary m-3" data-toggle="modal" data-target="#CreateQuestionModal">Create Question</button>
    <div id="tests-wrapper">
        <h3>{{test.title}}</h3>
        <ol id="questions-list">
            {% for question in test.questions.all %}
            <li id="question{{question.id}}">
                {{question.problem}}
                <div class="btn btn-danger question-delete-button m-3" data-url="{% url 'question-delete' test_id=test.id question_id=question.id %}" data-id={{question.id}}>delete question</div>
                <a href="{% url 'question-update' test_id=test.id question_id=question.id %}">update question</a>
                <ul id="answers-list{{question.id}}">
                {% for answer in question.answers.all %}
                    <li id="answer{{answer.id}}" {% if answer.is_correct %} class="list-group-item list-group-item-success" {% else %} class="list-group-item list-group-item-danger">{% endif %}
                        <label class="form-check-label" for="answer{{answer.id}}">{{answer.text}}</label>
                        <div class="btn btn-danger answer-delete-button m-3" data-url="{% url 'answer-delete' test_id=test.id answer_id=answer.id %}" data-id="{{answer.id}}">delete answer</div>
                        <a href="{% url 'answer-update' test_id=test.id answer_id=answer.id %}">update answer</a>
                    </li>
                {% endfor %}
                </ul>
                <form action="{% url 'answer-create' test_id=test.id question_id=question.id %}" data-question-id="{{question.id}}" id="answer-form{{question.id}}" class="answer-form">{% csrf_token %}
                    {{answer_form}}
                    <button type="submit">create</button>
                </form>
            </li>
            {% endfor %}
        </ol>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script>
        $("#question-form").submit(function (e) {
            e.preventDefault();
            
            var question_form = $(this);
            
            $.ajax({
                type: "POST",
                url: question_form.attr('action'),
                data: question_form.serialize(),
                success: function (response) {
                    $("#question-form").trigger('reset');
                    $("#id_problem").focus();

                    var instance = JSON.parse(response["new_question"]);
                    var question_id = instance[0]["pk"];
                    var fields = instance[0]["fields"];
                    var delete_url = response["delete_url"];
                    var update_url = response['update_url'];
                    var answer_create_url = response["answer_create_url"];

                    $("#questions-list").append(`
                    <li id="question${question_id}">
                        ${fields["problem"]||""}
                        <div class="btn btn-danger question-delete-button m-3" data-id="${question_id}" data-url="${delete_url}">delete question</div>
                        <a href="${update_url}">update question</a>
                        <ul id="answers-list${question_id}">
                        </ul>
                        <form action="${answer_create_url}" data-question-id="${question_id}" id="answer-form${question_id}" class="answer-form">{% csrf_token %}
                            {{answer_form}}
                            <button type="submit">create</button>
                        </form>
                    </li>
                    `);
                }
            })
        });


        $(document.body).on('submit', '.answer-form', function (e) {
            e.preventDefault();
            var question_id = this.getAttribute('data-question-id');

            var answer_form = $(this);
            
            $.ajax({
                type: "POST",
                url: answer_form.attr('action'),
                data: answer_form.serialize(),
                success: function (response) {
                    var answer_form = $(`#answer-form${question_id}`);
                    answer_form.trigger('reset');

                    var text_field = answer_form[0]['elements'][1];
                    text_field.focus();

                    var instance = JSON.parse(response["new_answer"]);
                    var fields = instance[0]["fields"];
                    var delete_url = response["delete_url"];
                    var update_url = response["update_url"];
                    var answer_id = instance[0]["pk"];
                    
                    if (fields['is_correct']) {
                        $(`#answers-list${question_id}`).append(`
                        <li id="answer${answer_id}" class="list-group-item list-group-item-success">
                            <label class="form-check-label" for="answer${answer_id}">${fields["text"]||""}</label>
                            <div class="btn btn-danger answer-delete-button m-3" href="${delete_url}" data-url="${delete_url}" data-id="${answer_id}">delete answer</div>
                            <a href="${update_url}">update answer</a>
                        </li>
                        `)
                    }
                    else {
                        $(`#answers-list${question_id}`).append(`
                        <li id="answer${answer_id}" class="list-group-item list-group-item-danger">
                            <label class="form-check-label" for="answer${answer_id}">${fields["text"]||""}</label>
                            <div class="btn btn-danger answer-delete-button m-3" href="${delete_url}" data-url="${delete_url}" data-id="${answer_id}">delete answer</div>
                            <a href="${update_url}">update answer</a>
                        </li>
                        `)
                    }
                    
                },
                error: function (response) {
                    alert(response["responseJSON"]["error"]);
                }
            })
        });

        var csrfToken = $("input[name=csrfmiddlewaretoken]").val();

        $(document.body).on('click', '.question-delete-button', function (e){
            e.stopPropagation();
            var delete_url = $(this).data('url');
            var data_id = $(this).data('id');
            $.ajax({
                type: "POST",
                url: `${delete_url}`,
                data: {
                    csrfmiddlewaretoken: csrfToken,
                    test_id: "{{test.id}}",
                    question_id: data_id
                },
                dataType: 'json',
                success: function() {
                    $(`#question${data_id}`).remove();
                }
            })
        });

        $(document.body).on('click', '.answer-delete-button', function (e){
            e.stopPropagation();
            var delete_url = $(this).data('url');
            var data_id = $(this).data('id');
            $.ajax({
                type: "POST",
                url: `${delete_url}`,
                data: {
                    csrfmiddlewaretoken: csrfToken,
                    test_id: "{{test.id}}",
                    answer_id: data_id
                },
                dataType: 'json',
                success: function() {
                    $(`#answer${data_id}`).remove();
                }
            })
        })
    </script>
</body>
</html>